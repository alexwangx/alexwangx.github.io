<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka Practices :: The Cuddly Computing Machine</title>
    <link rel="canonical" href="http://alexwangx.github.io/cuddly-blog/1.2/alex/kafka/kafka_practices.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86782445-1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-86782445-1')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="http://alexwangx.github.io">The Cuddly Computing Machine</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/alexwangx">GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="cuddly-blog" data-version="1.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Cuddly Blog</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hadoop</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hadoop/ops/hadoop_commands.html">Hadoop Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hadoop/ops/hadoop_practices.html">Hadoop Practices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hadoop/ops/hadoop_jmx.html">Hadoop JMX</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hadoop/ops/hadoop_delroot.html">Hadoop 意外删除挽救</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Spark</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spark/ops/spark-exitcode.html">Spark 任务退出码</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spark/ops/spark-issues.html">Spark 常见错误</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hbase</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hbase/hbase_notes.html">Hbase Notes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hbase/hbase_issues.html">Hbase Issues</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kafka</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="kafka_practices.html">Kafka Practices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kafka_issues.html">Kafka Issues</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Druid</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/tutorial-load-data.html">Druid 导入数据</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/druid-internals.html">Druid 0.1.5 架构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/broker.html">Druid Broker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/coordinator.html">Druid Coordinator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/historical.html">Druid Historical</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/middleManager.html">Druid MiddleManager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/overlord.html">Druid Overlord</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/router.html">Druid Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../druid/segment.html">Druid Segments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Install</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/druid.html">Druid 安装</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/hadoop_krb.html">Hadoop 配置 Kerberos</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Other</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other/mac.html">Mac 杂记</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other/linux.html">Linux 杂记</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other/maven.html">Maven 杂记</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other/mysql_install.html">Mysql 安装</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../other/readlist.html">北京中小学孩子读书清单</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../flink/index.html">Flink</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../flink/training/index.html">Flink Training Home</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Streaming 介绍</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/intro/streaming.html">Streaming with Apache Flink</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/intro/what-can-be.html">What can be Streamed?</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/intro/example.html">A Complete Example</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">环境配置</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/labs/dev-env.html">Setup your Development Environment</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/labs/use-taxi-data.html">Using the Taxi Data Streams</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/labs/how-to-do.html">How to do the Labs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../flink/training/lab1/filtering.html">Lab 1 - Filtering a Stream</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Transforming Data</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/lab1/stateless-trans.html">Stateless Transformations</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/lab1/keyed-streams.html">Keyed Streams</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../flink/training/lab1/stateful-trans.html">Stateful Transformations</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cuddly Blog</span>
    <span class="version">1.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cuddly Blog</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Cuddly Blog</a></li>
    <li>Kafka</li>
    <li><a href="kafka_practices.html">Kafka Practices</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1 class="page">Kafka Practices</h1>
<div class="sect1">
<h2 id="_producer"><a class="anchor" href="#_producer"></a>Producer</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Producer 配置</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>说明</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">备注</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">request.required.acks</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>0 producer无须等待leader确认</p>
</li>
<li>
<p>1 需要leader写入本地log之后立即确认</p>
</li>
<li>
<p>-1 代表所有数据复制完成之后确认</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">producer.type=sync</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>写入数据频率很高时, 使用async异步方式, 以batch形式写入. 如果producer挂掉的话, 会丢失数据.</p>
</li>
<li>
<p>使用多线程(多producer)发送数据, 从而提高吞吐量</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch.num.messages=200</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>批量发送的消息数</p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queue.buffer.max.ms=500</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>单位毫秒. 判断条件1,2满足一个即可发送batch消息</p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queue.buffering.max.messages=1000</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>缓存消息数量</p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compression.codec=none</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>gzip/snappy压缩. 官方测试,gzip压缩效率高于snappy.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compressed.topics=null</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>启用压缩的tpoic</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">消息压缩(适用于大消息) consumer消费消息时自行解压缩</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_broker"><a class="anchor" href="#_broker"></a>Broker</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Broker 配置</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>配置</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>说明</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>备注</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>num.partitions=20</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>配置多个 partitions</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>多个partition会增加延迟io/网络,但是最大化的增加了consumer的吞吐</p>
</li>
<li>
<p>tips: 可以使用 kafka-reassign-partitions.sh 重新调整分区</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>num.io.threads=8</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>M个Handler request 来处理业务逻辑, 配置需要大一些, cpu核数的2倍, 不超过3倍</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>num.network.threads=8</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>处理网络io, 读写缓冲区 SocketServer配置线程数为cpu核数+1, 基本上没有io等待</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Kafka SocketServer是基于Java NIO来开发的, 采用了Reactor的模式.</p>
</li>
<li>
<p>其中包含了1个Acceptor负责接受客户端请求, N个Processor线程负责读写数据,M个Handler来处理业务逻辑.</p>
</li>
<li>
<p>在Acceptor和Processor, Processor和Handler之间都有队列来缓冲请求.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>log.flush.interval.messages=1000</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>刷新到磁盘的消息数</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>log 落盘策略</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>log.flush.interval.ms=1000</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>每隔1秒写盘</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>log 落盘策略</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>num.relica.fetchers=1</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>配置更多可提高follower的io并发度</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>replica.lag.max.messages</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>如果某个副本落后leader副本的消息数超过了这个值，那么leader副本就会把该follower副本从ISR中移除。
这个值是个全局参数,影响很多topic.</p>
</li>
<li>
<p>而每个topic生产速率不一样,从而导致很多follower与leader不同步、再同步、又不同步、再次同步的情况发生,影响性能.</p>
</li>
<li>
<p>解决办法就是把这个值调成最大,或者修改代码去掉这个参数的逻辑判断.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>0.10以下</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_consumer"><a class="anchor" href="#_consumer"></a>Consumer</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Consumer 配置</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>配置</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>说明</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>备注</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>session.timeout.ms</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一个相对较低的值,例如10秒. 用于心跳线程.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>如果coordinator在此时间间隔过去之前未能从消费者那里得到任何心跳</p>
</li>
<li>
<p>则它将consumer标记为失败并触发新一轮的rebalance.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>max.poll.interval.ms</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>业务处理耗时</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>用于用户consumer线程.</p>
</li>
<li>
<p>如果消息处理逻辑太重并且超过当前时间,则coordinator将明确要求consumer离开组并触发新一轮的rebalance.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>request.timeout.ms</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>必须一直比 <code>max.poll.interval.ms</code> 大</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>heartbeat.interval.ms</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>相对较低的值, 最好是 <code>session.timeout.ms</code> 的1/3</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>用于使其他健康的consumer更快地意识到rebalance.</p>
</li>
<li>
<p>发送心跳请求的间隔越短, consumer知道需要重新加入coordinator group的速度就越快.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
