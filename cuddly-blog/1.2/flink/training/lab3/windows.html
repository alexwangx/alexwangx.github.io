<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Windows :: The Cuddly Computing Machine</title>
    <link rel="canonical" href="http://alexwangx.github.io/cuddly-blog/1.2/flink/training/lab3/windows.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86782445-1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-86782445-1')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="http://alexwangx.github.io">The Cuddly Computing Machine</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/alexwangx">GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="cuddly-blog" data-version="1.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../index.html">Cuddly Blog</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Flink</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Flink Training Home</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Streaming 介绍</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../intro/intro-1.html">使用Apache Flink 进行流处理</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../intro/intro-2.html">流可以传输什么?</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../intro/intro-3.html">一个完整的例子</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">环境配置</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../labs/devEnvSetup.html">设置您的开发环境</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../labs/taxiData.html">使用出租车数据流</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../labs/howto-exercises.html">如何做实验室</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../lab1/rideCleansing.html">Lab 1 - 过滤流</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">数据转换</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab1/stateless.html">无状态转换</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab1/keyed-streams.html">Keyed 流</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab1/stateful.html">有状态的转换</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab1/connected-streams.html">连接流</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../lab2/rideEnrichment-flatmap.html">Lab 2 - Stateful Enrichment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">时间和分析</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="event-time-watermarks.html">Event Time and Watermarks</a>
  </li>
  <li class="nav-item is-current-page" data-depth="4">
    <a class="nav-link" href="windows.html">Windows</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Lab 3 - Windowing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="hourlyTips.html">Lab 3 - 窗口化分析</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="hourlyTips-discussion.html">Lab 3 - 讨论</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">事件驱动的应用</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab4/processfunction.html">ProcessFunction</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab4/side-outputs.html">Side Outputs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Lab 4 - 到期状态</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab4/rideEnrichment-processfunction.html">Lab 4 - 练习</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../lab4/expiring-state-discussion.html">Lab 4 - 讨论</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">容错能力</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../fault/state-backends.html">状态后端</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../fault/snapshots.html">检查点和保存点</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../app-dev.html">应用开发</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">其他练习</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../extra-labs/longRides.html">长途警报</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">广播状态</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../extra-labs/nearestTaxi.html">寻找最近的出租车</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../extra-labs/ongoingRides.html">报告正在进行的出租车</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../extra-labs/taxiQuery.html">规则引擎</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../extra-labs/eventTimeJoin.html">丰富的 Joins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../resources.html">资源链接</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../introduction/index.html">Flink 简介</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/architecture.html">Flink 架构介绍</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/failover.html">Flink 容错机制</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/scheduling.html">Flink 调度机制</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/statemachine.html">Flink 状态机</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/memorymanager.html">Flink 内存管理</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/dataflow.html">Flink Dataflow</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/batchdata.html">Flink 批处理</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../introduction/streamdata.html">Flink 流处理</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../internals/index.html">Flink 学习笔记</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Spark</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Spark ops</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../spark/ops/spark-exitcode.html">Spark 任务退出码</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../spark/ops/spark-issues.html">Spark 常见错误</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../spark/spark-internals/index.html">Spark 2.4.4 架构原理</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../spark/spark-internals/root/spark-overview.html">Overview</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hadoop</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../hadoop/hadoop_krb_install.html">Hadoop 配置 Kerberos</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hadoop ops</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hadoop/hdp-ops/hadoop_commands.html">Hadoop Commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hadoop/hdp-ops/hadoop_practices.html">Hadoop Practices</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hadoop/hdp-ops/hadoop_jmx.html">Hadoop JMX</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hadoop/hdp-ops/hadoop_delroot.html">Hadoop 意外删除挽救</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hbase</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hbase ops</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hbase/hbase-ops/hbase_notes.html">Hbase 基本命令</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../hbase/hbase-ops/hbase_issues.html">Hbase Issues</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Druid</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../druid/druid-install.html">Druid 安装</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Druid 架构</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/tutorial-load-data.html">Druid 导入数据</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/druid-internals.html">Druid 0.1.5 架构</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/broker.html">Druid Broker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/coordinator.html">Druid Coordinator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/historical.html">Druid Historical</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/middleManager.html">Druid MiddleManager</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/overlord.html">Druid Overlord</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/router.html">Druid Router</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../druid/druid-internals/segment.html">Druid Segments</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kafka</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../kafka/kafka_practices.html">Kafka Practices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../kafka/kafka_issues.html">Kafka Issues</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Other</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../mac.html">Mac OS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../linux.html">Linux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../mysql_install.html">Mysql 安装</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../readlist.html">北京中小学孩子读书清单</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../demo/demo.html">Adoc Demo</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cuddly Blog</span>
    <span class="version">1.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cuddly Blog</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../index.html">1.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../index.html">Cuddly Blog</a></li>
    <li>Flink</li>
    <li><a href="../index.html">Flink Training Home</a></li>
    <li>时间和分析</li>
    <li><a href="windows.html">Windows</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1 class="page">Windows</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Flink具有非常有表现力的窗口语义。</p>
</div>
<div class="paragraph">
<p>在本课程中，您将学习：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何使用窗口来计算无界流上的聚合</p>
</li>
<li>
<p>Flink支持哪种类型的Windows，以及</p>
</li>
<li>
<p>如何通过窗口聚合实现DataStream程序</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_介绍"><a class="anchor" href="#_介绍"></a>介绍</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在进行流处理时，自然要对流的有限子集计算聚合分析以回答如下问题：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>每分钟的页面浏览量</p>
</li>
<li>
<p>每个用户每周的会话数</p>
</li>
<li>
<p>每分钟的最高票价</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>用 Flink 计算窗口分析取决于两个主要的抽象：将事件分配给窗口的窗口分配器(根据需要创建新的窗口对象)，以及应用于分配给窗口的事件的窗口函数。</p>
</div>
<div class="paragraph">
<p>Flink 的窗口 API 还具有触发器(用于确定何时调用窗口函数)和退出器(可以删除窗口中收集的元素)的概念。</p>
</div>
<div class="paragraph">
<p>在其基本形式中，您将开窗应用于如下所示的键控流：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">stream.
  .keyBy(&lt;key selector&gt;)
  .window(&lt;window assigner&gt;)
  .reduce|aggregate|process(&lt;window function&gt;)</code></pre>
</div>
</div>
<div class="paragraph">
<p>您还可以对 non-keyed 流使用窗口，但请记住，在这种情况下，处理不会并行进行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">stream.
  .windowAll(&lt;window assigner&gt;)
  .reduce|aggregate|process(&lt;window function&gt;)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_窗口分配器"><a class="anchor" href="#_窗口分配器"></a>窗口分配器</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Flink 具有几种内置的窗口分配器类型，如下所示：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/training/window-assigners.svg" alt="window assigners">
</div>
</div>
<div class="paragraph">
<p>这些窗口分配器的用途以及如何指定窗口分配器的一些示例：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tumbling time windows</p>
<div class="ulist">
<ul>
<li>
<p>每分钟浏览量</p>
</li>
<li>
<p><code>TumblingEventTimeWindows.of(Time.minutes(1))</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Sliding time windows</p>
<div class="ulist">
<ul>
<li>
<p>每10秒计算的每分钟浏览量</p>
</li>
<li>
<p><code>SlidingEventTimeWindows.of(Time.minutes(1), Time.seconds(10))</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Session windows</p>
<div class="ulist">
<ul>
<li>
<p>每个会话的网页浏览量，其中会话之间的间隔至少为30分钟</p>
</li>
<li>
<p><code>EventTimeSessionWindows.withGap(Time.minutes(30))</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>可以使用 <code>Time.milliseconds(n)</code> ，<code>Time.seconds(n)</code> ，<code>Time.minutes(n)</code> ，<code>Time.hours(n)</code> 和 <code>Time.days(n)</code> 之一来指定持续时间。</p>
</div>
<div class="paragraph">
<p>基于时间的窗口分配器（包括会话窗口）具有事件时间和处理时间两种风格。 在这两种类型的时间窗口之间存在重大折衷。 使用处理时间窗口化时，您必须接受以下限制：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>无法处理历史数据</p>
</li>
<li>
<p>无法正确处理乱序数据</p>
</li>
<li>
<p>结果将是不确定的</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>但具有较低延迟的优势。</p>
</div>
<div class="paragraph">
<p>使用基于计数的窗口时，请记住，直到完成批处理后，这些窗口才会触发。 尽管您可以使用自定义触发器自己实现该行为，但无法选择超时和处理部分窗口。</p>
</div>
<div class="paragraph">
<p>全局窗口分配器将每个事件（具有相同的键）分配给相同的全局窗口。 仅当您要使用自定义触发器进行自定义窗口时，此功能才有用。 在大多数情况下，这看起来似乎很有用，您最好使用另一节中介绍的 <a href="../lab4/processfunction.html" class="page">ProcessFunction</a>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_窗口函数"><a class="anchor" href="#_窗口函数"></a>窗口函数</h2>
<div class="sectionbody">
<div class="paragraph">
<p>您具有三个基本选项来处理窗口内容：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>使用 <code>ProcessWindowFunction</code> 作为批处理，该函数将传递带有窗口内容的 Iterable ；</p>
</li>
<li>
<p>在每个事件分配给窗口时调用带有 <code>ReduceFunction</code> 或 <code>AggregateFunction</code> 的增量方法；</p>
</li>
<li>
<p>或两者结合使用，其中在触发窗口时，将 <code>ReduceFunction</code> 或 <code>AggregateFunction</code> 的预聚合结果提供给 <code>ProcessWindowFunction</code>。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>这里是方法1和方法3的示例。在每种情况下，我们都是在1分钟的事件时间窗口中从每个传感器中找到峰值，并生成包含 <code>(key, end-of-window-timestamp, max_value)</code> 的元组流。</p>
</div>
<div class="sect2">
<h3 id="_processwindowfunction_例子"><a class="anchor" href="#_processwindowfunction_例子"></a>ProcessWindowFunction 例子</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DataStream&lt;SensorReading&gt; input = ...

input
  .keyBy(“key”)
  .window(TumblingEventTimeWindows.of(Time.minutes(1)))
  .process(new MyWastefulMax());

public static class MyWastefulMax extends ProcessWindowFunction&lt;
  SensorReading,                  // input type
  Tuple3&lt;String, Long, Integer&gt;,  // output type
  Tuple,                          // key type
  TimeWindow&gt; {                   // window type

    @Override
    public void process(
      Tuple key,
      Context context,
      Iterable&lt;SensorReading&gt; events,
      Collector&lt;Tuple3&lt;String, Long, Integer&gt;&gt; out) {
        int max = 0;
        for (SensorReading event : events) {
          if (event.value &gt; max) max = event.value;
        }
		// note the rather hideous cast
        out.collect(new Tuple3&lt;&gt;((Tuple1&lt;String&gt;)key).f0, context.window().getEnd(), max));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>此实现中需要注意的几件事：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>key 选择器被指定为一个编码为String 类型的字段名称。 这使编译器无法知道我们的 key 是字符串，因此在 <code>ProcessWindowFunction</code> 中必须使用的 key 类型是元组。 请注意在最后一行中使用的强制转换。</p>
</li>
<li>
<p>分配给窗口的所有事件都必须以 keyed 状态进行缓冲，直到触发窗口为止。 这可能是相当昂贵的。</p>
</li>
<li>
<p>我们的 <code>ProcessWindowFunction</code> 传递了一个Context对象，我们可以从中获取有关窗口的信息。 如下所示：</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public abstract class Context implements java.io.Serializable {
    public abstract W window();

    public abstract long currentProcessingTime();
    public abstract long currentWatermark();

    public abstract KeyedStateStore windowState();
    public abstract KeyedStateStore globalState();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>windowState</code> 和 <code>globalState</code> 是可以存储每个键，每个窗口或全局每个键信息的位置。 例如，如果要记录有关当前窗口的内容并在处理后续窗口时使用它，这可能会很有用。</p>
</div>
</div>
<div class="sect2">
<h3 id="_增量聚合示例"><a class="anchor" href="#_增量聚合示例"></a>增量聚合示例</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DataStream&lt;SensorReading&gt; input = ...

input
  .keyBy(x -&gt; x.key)
  .window(TumblingEventTimeWindows.of(Time.minutes(1)))
  .reduce(new MyReducingMax(), new MyWindowFunction());

private static class MyReducingMax implements ReduceFunction&lt;SensorReading&gt; {
  public SensorReading reduce(SensorReading r1, SensorReading r2) {
    return r1.value() &gt; r2.value() ? r1 : r2;
  }
}

private static class MyWindowFunction extends ProcessWindowFunction&lt;
  SensorReading, Tuple3&lt;String, Long, SensorReading&gt;, String, TimeWindow&gt; {

  @Override
  public void process(
    String key,
    Context context,
    Iterable&lt;SensorReading&gt; maxReading,
    Collector&lt;Tuple3&lt;String, Long, SensorReading&gt;&gt; out) {

    SensorReading max = maxReading.iterator().next();
    out.collect(new Tuple3&lt;String, Long, SensorReading&gt;(key, context.window().getEnd(), max));
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>通过此实现，我们选择使用更强大的KeySelector。 还要注意，<code>Iterable&lt;SensorReading&gt;</code> 将只包含一个读数-由 <code>MyReducingMax</code> 计算的预先汇总的最大值。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_后期事件"><a class="anchor" href="#_后期事件"></a>后期事件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>默认情况下，使用事件时间窗口时，将删除后期事件。窗口API的两个可选部分使您可以对此进行更多控制。</p>
</div>
<div class="paragraph">
<p>您可以使用称为 <a href="hourlyTips-discussion.html" class="page">Side Outputs</a> 的机制安排将要删除的事件收集到备用输出流中。这是一个可能看起来像的例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OutputTag&lt;Event&gt; lateTag = new OutputTag&lt;Event&gt;("late"){};

SingleOutputStreamOperator&lt;Event&gt; result = stream.
  .keyBy(...)
  .window(...)
  .sideOutputLateData(lateTag)
  .process(...);

DataStream&lt;Event&gt; lateStream = result.getSideOutput(lateTag);</code></pre>
</div>
</div>
<div class="paragraph">
<p>您还可以指定允许的延迟间隔，在此间隔内，延迟事件将继续分配给适当的窗口(其状态将被保留)。默认情况下，每个延迟事件都会导致窗口功能延迟触发。</p>
</div>
<div class="paragraph">
<p>默认情况下，允许的延迟为0。换句话说，水印后的元素将被删除(或发送到另外的输出)。</p>
</div>
<div class="paragraph">
<p>例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">stream.
  .keyBy(...)
  .window(...)
  .allowedLateness(Time.seconds(10))
  .process(...);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_surprises"><a class="anchor" href="#_surprises"></a>Surprises</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Flink的窗口API的某些方面可能无法达到您预期的效果。根据有关 <a href="https://stackoverflow.com/questions/tagged/apache-flink" target="_blank" rel="noopener">Stack Overflow</a> 和 <a href="https://flink.apache.org/community.html#mailing-lists" target="_blank" rel="noopener">flink-user</a> 邮件列表的常见问题，以下是一些有关Windows的事实，这些信息可能会让您感到惊讶。</p>
</div>
<div class="sect2">
<h3 id="_滑动windows进行复印"><a class="anchor" href="#_滑动windows进行复印"></a>滑动Windows进行复印</h3>
<div class="paragraph">
<p>滑动窗口分配器可以创建许多窗口对象，并将每个事件复制到每个相关的窗口中。 例如，如果您每隔15分钟就有24小时的滑动窗口，则每个事件将被复制到4 * 24 = 96个窗口中。</p>
</div>
</div>
<div class="sect2">
<h3 id="_时间窗口与时代对齐"><a class="anchor" href="#_时间窗口与时代对齐"></a>时间窗口与时代对齐</h3>
<div class="paragraph">
<p>仅仅因为您正在使用一个小时的处理时间窗口并在12:05开始运行应用程序，并不意味着第一个窗口将在1:05关闭。第一个窗口将长55分钟，并在1:00关闭。</p>
</div>
</div>
<div class="sect2">
<h3 id="_windows可以跟随windows"><a class="anchor" href="#_windows可以跟随windows"></a>Windows可以跟随Windows</h3>
<div class="paragraph">
<p>例如，它可以做到这一点：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">stream
  .keyBy(t -&gt; t.key)
  .timeWindow(&lt;time specification&gt;)
  .reduce(&lt;reduce function&gt;)
  .timeWindowAll(&lt;same time specification&gt;)
  .reduce(&lt;same reduce function&gt;)</code></pre>
</div>
</div>
<div class="paragraph">
<p>您可能希望Flink的运行时足够聪明，可以为您执行此并行预聚合(前提是您使用的是ReduceFunction或AggregateFunction)，但事实并非如此。</p>
</div>
</div>
<div class="sect2">
<h3 id="_空的timewindows没有结果"><a class="anchor" href="#_空的timewindows没有结果"></a>空的TimeWindows没有结果</h3>
<div class="paragraph">
<p>仅在将事件分配给它们时才创建Windows。因此，如果在给定的时间范围内没有任何事件，则不会报告任何结果。</p>
</div>
</div>
<div class="sect2">
<h3 id="_后期事件可能导致后期合并"><a class="anchor" href="#_后期事件可能导致后期合并"></a>后期事件可能导致后期合并</h3>
<div class="paragraph">
<p>会话窗口基于可以合并的窗口的抽象。 每个元素最初都分配给一个新窗口，此后只要它们之间的间隙足够小，就会合并这些窗口。 这样，延迟事件可以弥合分隔两个先前分开的会话的间隔，从而产生延迟合并。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_进一步阅读"><a class="anchor" href="#_进一步阅读"></a>进一步阅读</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://flink.apache.org/news/2015/12/04/Introducing-windows.html" target="_blank" rel="noopener">Introducing Stream Windows in Apache Flink</a> (Apache Flink blog)
<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html" target="_blank" rel="noopener">Windows</a> (Apache Flink Documentation)</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../../_/js/site.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
